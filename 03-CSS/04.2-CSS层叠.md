# CSS 层叠

层叠是 CSS 的一个基本特征，**它是一个定义了如何合并来自多个源的属性值的算法**。它在 CSS 处于核心地位，CSS 的全称层叠样式表正是强调了这一点。

## 哪些 CSS 实体会参与层叠计算

只有 CSS 声明，就是属性名值对，会参与层叠计算。这表示包含 CSS 声明以外实体的 **@规则不参与层叠计算，比如包含描述符（descriptors）的@font-face。** 对于这些情形，@规则是做为一个整体参与层叠计算，比如 @font-face 的层叠是由其描述符 font-family 确定的。如果对同一个描述符定义了多次 @font-face，则最适合的 @font-face 是做为一个整体而被考虑的。

包含在大多数 @规则的 CSS 声明是参与层叠计算的，比如包含于@media、@documents或者@supports的 CSS 声明，但是包含于@keyframes的声明不参与计算，正如@font-face，它是作为一个整体参与层叠算法的筛选。

最后，**注意 @import 和 @charset 遵循特定的算法，并且不受层叠算法影响。**

## CSS 声明的源

CSS 层叠算法期望通过挑选 CSS 声明来给 CSS 属性设置正确的值。**CSS 声明可以有不同的来源**：

浏览器会有一个基本的样式表来给任何网页设置默认样式。这些样式统称用户代理样式。一些浏览器通过使用真正的样式表，而其他则通过代码模拟，但无论是哪种情形都应是不可被检测的。而且部分浏览器允许用户修改用户代理样式。尽管 HTML 标准对用户代理样式做了诸多限制，浏览器仍大有可为，具体表现在不同浏览器间会存在重大的差异。为了减轻开发成本以及降低样式表运行所需的基本环境，**网页开发者通常会使用一个 CSS reset 样式表，强制将常见的属性值转为确定状态。**
网页的作者可以定义文档的样式，这是最常见的样式表。大多数情况下此类型样式表会定义多个，它们构成网站的视觉和体验，即主题。
读者，作为浏览器的用户，可以使用自定义样式表定制使用体验。
尽管 CSS 样式会来自这些不同的源，但它们的作用范围是重叠的，而层叠算法则定义了它们如何相互作用。

## 层叠顺序

> **“用户代理”指的是浏览器。**
**“用户”指的是是网站访问者。**
**“作者”指的是你，开发者。**
用 `<style>` 元素直接在元素上声明的样式是作者样式。
不包括动画和过渡样式，用户代理普通样式具有最低优先权；用户代理重要样式具有最高优先权。

层叠算法决定如何找出要应用到每个文档元素的每个属性上的值。

1. 它首先过滤来自不同源的全部规则，并保留要应用到指定元素上的那些规则。这意味着这些规则的选择器匹配指定元素，同时也是一个合适的 @规则（at-rule）的一部分。
2. 其次，它依据重要性对这些规则进行排序。即是指，规则后面是否跟随者 !import 以及规则的来源。层叠是按升序排列的，这意味着来着用户自定义样式表的 !important 值比用户代理样式表的普通值优先级高：
    -|来源 |重要程度
    --|--|--
    1| 用户代理 |普通
    2| 用户 |普通
    3| 页面作者| 普通
    4| CSS 动画 |见下节
    5| 页面作者 |!important
    6| 用户 |!important
    7| 用户代理| !important
    8| css 过渡| (css transitions)
3. 假如层叠顺序相等，则使用哪个值取决于优先级。

## 重置样式

当你的 css 对样式完成更改之后，也许会在某种情况下希望把他们还原到一个已知样式上，这可能发生在动画、主题修改之类的情形中。**CSS 属性`all`能够让你快速地把（几乎）所有 CSS 属性设置到一个已知样式上。**

`all` 属性让你能够立刻把所有的属性都还原到它们初始（默认）的状态，或是继承自前一个层叠顺序等级的状态，又或是指定一个特定的来源（用户代理、页面作者或者用户），甚至还可以选择完全清除所有的属性。

### 扩展：all属性

css

```css
/* Global values */
all: initial
all: inherit
all: unset

/* CSS Cascading and Inheritance Level 4 */
all: revert;
```

- **initial**
该关键字代表改变该元素或其父元素的所有属性至初始值。

- **inherit**
该关键字代表改变该元素或其父元素的所有属性的值至他们的父元素属性的值。inherited values

- **unset**
该关键字代表如果该元素的属性的值是可继承的，则改变该元素或该元素的父元素的所有属性的值为他们父元素的属性值，反之则改变为初始值。

- **revert**
指定依赖于声明所属的样式表原点的行为：

  - **User-agent origin**
相当于 unset

  - **User origin**
将层叠回滚到用户代理级别，以便计算指定的值，就好像没有为该元素指定作者级别或用户级别规则。

  - **Author origin**
将层叠回滚到用户级别，以便计算指定的值，就好像没有为元素指定作者级规则。出于revert的目的，“作者”原点包括“覆盖”和“动画”原点。

[举例：all.html](Code/%E5%B1%82%E5%8F%A0/all.html)

## 层叠如何定义在不止一个元素的时候怎么应用 CSS 规则

有三个因素需要考虑，根据重要性排序如下，后面的更重要：

- 资源顺序
- 优先级
- 重要程度

### 资源顺序

我们已经看到了顺序对于层叠的重要性。**如果你有超过一条规则，而且都是相同的权重，那么最后面的规则会应用。可以理解为后面的规则覆盖前面的规则，直到最后一个开始设置样式。**

资源顺序仅在规则的优先级相同时才体现出来，下面让我们看一下优先级：

### 优先级

你会发现在一些情况下，有些规则在最后出现，但是却应用了前面的具有冲突的规则。这是因为前面的有更高的优先级——它范围更小，因此浏览器就把它选择为元素的样式。

就像前面看到的，**类选择器的权重大于元素选择器，因此类上定义的属性将覆盖应用于元素上的属性。**

这里需要注意虽然我们考虑的是选择器，以及应用在选中对象上的规则，但不会覆盖所有规则，只覆盖相同的属性。

这样可以避免重复的 CSS。一种常见的做法是给基本元素定义通用样式，然后给不同的元素创建对应的类。举个例子，在下面的样式中我给 2 级标题定义了通用样式，然后创建了一些类只修改部分属性的值。最初定义的值应用于所有标题，然后更具体的值通过对应类来实现。

## CSS 动画与层叠

CSS 动画 ，指使用@keyframes @规则定义状态间的动画。关键帧不参与层叠，意味着在任何时候 CSS 都是取单一的 @keyframes 的值而不会是某几个 @keyframe 的混合。

当有多个满足条件的关键帧时，在最重要的文档里面最后定义的关键帧会被选中，而不会是将它们组合在一起。

同时仍应注意用 @keyframes @规则定义的值会覆盖全部普通值，但会被 !important 的值覆盖。

## 例子

用户代理 CSS：

```css
li {
  margin-left: 10px;
}
```

网页作者 CSS1：

```css
li {
  margin-left: 0;
} /* This is a reset */
```

网页作者 CSS2：

```css
@media screen {
  li {
    margin-left: 3px;
  }
}

@media print {
  li {
    margin-left: 1px;
  }
}
```

用户 CSS：

```css
.specific {
  margin-left: 1em;
}
```

HTML：

```HTML
<ul>
  <li class="specific">1<sup>st</sup></li>
  <li>2<sup>nd</sup></li>
</ul>
```

对于这个情形，应当应用 `li` 和`.specific` 里面的声明。**由于没有声明被标记为 `!important`**，所以优先顺序为**页面作者样式优于用户样式，用户代理样式最低**。

故是这 3 条声明的竞争：

CSS

```css
margin-left: 0;
```

```CSS
margin-left: 3px;
```

```CSS
margin-left: 1px;
```

由于是在屏幕显示，所以最后一条舍弃，而前两条的选择器相同，因此优先级也相同，故最终选择的是后者：

CSS

```css
margin-left: 3px;
```

注意尽管定义在用户 CSS 里面的声明有更高的优先级，但它并不会被选中，因为层叠算法是先于优先级算法的。

## 技能测试

要求：
使用控制继承部分中看到的一个特殊值。
在不使用实际颜色值的情况下，在新规则中编写一个声明，将背景颜色重置回白色。

```html
<style>
#outer div ul .nav a {
  background-color: powderblue;
  padding: 5px;
  display: inline-block;
  margin-bottom: 10px;
}

div div li a {
  color: rebeccapurple;
}
</style>
<div id="outer" class="container">
  <div id="inner" class="container">
    <ul>
      <li class="nav"><a href="#">One</a></li>
      <li class="nav"><a href="#">Two</a></li>
    </ul>
  </div>
</div>

```

[test.html](Code/%E4%BC%98%E5%85%88%E7%BA%A7/%E7%BB%83%E4%B9%A0/test1.html)
